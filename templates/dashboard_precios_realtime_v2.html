{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - INTRADIA{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        padding: 2rem 0;
        min-height: calc(100vh - 80px);
    }
    
    /* Status Badges */
    #connectionStatus {
        position: fixed;
        top: 90px;
        right: 20px;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        z-index: 1000;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    #connectionStatus.connected {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }
    
    #connectionStatus.disconnected {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
    
    #balanceStatus {
        position: fixed;
        top: 140px;
        right: 20px;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        z-index: 1000;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    
    /* Dashboard Header */
    .dashboard-header-card {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(6, 182, 212, 0.2));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(20px);
        position: relative;
        overflow: hidden;
    }
    
    .dashboard-header-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }
    
    .dashboard-header-card h1 {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #ffffff, #cbd5e1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
    }
    
    /* Symbol Selector */
    .symbol-selector {
        background: var(--dark-card);
        border: 1px solid var(--dark-border);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .symbol-selector h4 {
        color: var(--text-primary);
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .symbol-btn {
        margin: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--dark-border);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .symbol-btn:hover {
        background: rgba(99, 102, 241, 0.2);
        border-color: var(--primary-color);
        color: var(--text-primary);
        transform: translateY(-2px);
    }
    
    .symbol-btn.active {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-color: var(--primary-color);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    
    /* Price Display Card */
    .price-card {
        background: var(--dark-card);
        border: 1px solid var(--dark-border);
        border-radius: 20px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .price-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .price-card:hover::before {
        transform: scaleX(1);
    }
    
    .price-display {
        font-size: 4rem;
        font-weight: 800;
        font-family: 'JetBrains Mono', monospace;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 1rem 0;
        animation: pulse-glow 2s infinite;
    }
    
    @keyframes pulse-glow {
        0%, 100% {
            opacity: 1;
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }
        50% {
            opacity: 0.9;
            filter: drop-shadow(0 0 20px rgba(99, 102, 241, 0.8));
        }
    }
    
    .price-change {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 1rem;
    }
    
    .price-change.positive {
        color: var(--success-color);
    }
    
    .price-change.negative {
        color: var(--danger-color);
    }
    
    /* Metric Cards */
    .metric-card {
        background: var(--dark-card);
        border: 1px solid var(--dark-border);
        border-radius: 15px;
        padding: 2rem;
        height: 100%;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color);
        box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
    }
    
    .metric-card:hover::before {
        transform: scaleX(1);
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 800;
        font-family: 'JetBrains Mono', monospace;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .metric-value.pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    /* Orders Containers */
    .orders-container {
        background: var(--dark-card);
        border: 1px solid var(--dark-border);
        border-radius: 15px;
        padding: 1.5rem;
        height: 400px;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    .orders-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .orders-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }
    
    .orders-container::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.3);
        border-radius: 10px;
    }
    
    .orders-container::-webkit-scrollbar-thumb:hover {
        background: rgba(99, 102, 241, 0.5);
    }
    
    .order-card {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid var(--dark-border);
        border-left: 4px solid;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
    }
    
    .order-card:hover {
        background: rgba(99, 102, 241, 0.15);
        transform: translateX(5px);
    }
    
    .order-card.active { border-left-color: var(--success-color); }
    .order-card.won { border-left-color: var(--primary-color); }
    .order-card.lost { border-left-color: var(--danger-color); }
    
    /* Table Styles */
    .table-dark {
        background: transparent;
        color: var(--text-primary);
    }
    
    .table-dark thead th {
        border-bottom: 2px solid var(--dark-border);
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .table-dark tbody tr {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.2s ease;
    }
    
    .table-dark tbody tr:hover {
        background: rgba(99, 102, 241, 0.1);
    }
    
    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.8rem;
    }
    
    .bg-success { background: var(--success-color) !important; }
    .bg-danger { background: var(--danger-color) !important; }
    .bg-warning { background: var(--warning-color) !important; }
    
    /* Section Headers */
    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .section-header i {
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        /* Elementos flotantes eliminados - ahora en navbar */
            position: relative;
            top: auto;
            right: auto;
            margin-bottom: 1rem;
        }
        
        .price-display {
            font-size: 2.5rem;
        }
        
        .dashboard-header-card h1 {
            font-size: 1.8rem;
        }
    }
    
    /* Floating Animation */
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    .floating {
        animation: float 3s ease-in-out infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container-fluid">
        <!-- Status Badges eliminados - ahora est√°n en el navbar -->

        <!-- Dashboard Header -->
        <div class="dashboard-header-card">
            <h1><i class="fas fa-chart-line"></i> Dashboard de Trading</h1>
            <p class="text-secondary mb-0">Sistema de trading automatizado con actualizaciones instant√°neas</p>
        </div>

        <!-- Balance Prominente y Estado -->
        <div class="row g-4 mb-4">
            <div class="col-12 col-md-8">
                <div class="metric-card text-center" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(6, 182, 212, 0.2)); border: 2px solid var(--primary-color);">
                    <div class="metric-label" style="font-size: 1.2rem; margin-bottom: 1rem;">
                        <i class="fas fa-wallet"></i> Balance Actual
                    </div>
                    <div class="metric-value" id="mainBalanceAmount" style="font-size: 3.5rem; font-weight: 800; color: var(--accent-color);">
                        $0.00
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="metric-card text-center" id="tradingStateCard" style="min-height: 100%;">
                    <div class="metric-label" style="font-size: 1.1rem; margin-bottom: 1rem;">
                        <i class="fas fa-chart-line"></i> Estado del Trading
                    </div>
                    <div id="tradingState" style="font-size: 1.8rem; font-weight: 700; padding: 1rem;">
                        <span class="badge bg-secondary" style="font-size: 1.2rem; padding: 0.5rem 1rem;">Cargando...</span>
                    </div>
                    <div id="tradingStateDetails" class="mt-2" style="font-size: 0.9rem; color: var(--text-secondary);">
                        <small>Analizando...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics Row -->
        <div class="row g-4 mb-4" id="metricsRow">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-label">P&L Total</div>
                    <div class="metric-value" id="totalPnl">$0.00</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value" id="winRate">0%</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-value" id="totalTrades">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-label">Active Trades</div>
                    <div class="metric-value pulse" id="activeTrades">0</div>
                </div>
            </div>
        </div>

        <!-- Orders Row - Prioridad a las tablas -->
        <div class="row g-4 mb-4">
            <!-- Active Orders -->
            <div class="col-12 col-lg-6">
                <div class="metric-card" style="min-height: 500px;">
                    <h3 class="section-header">
                        <i class="fas fa-play-circle"></i>
                        <span>Operaciones Activas</span>
                    </h3>
                    <div class="orders-container" id="activeOrdersContainer" style="max-height: 450px; overflow-y: auto;">
                        <p class="text-center text-muted">Sin operaciones activas</p>
                    </div>
                </div>
            </div>

            <!-- Closed Orders -->
            <div class="col-12 col-lg-6">
                <div class="metric-card" style="min-height: 500px;">
                    <h3 class="section-header">
                        <i class="fas fa-check-circle"></i>
                        <span>Operaciones Finalizadas</span>
                        <button class="btn btn-sm btn-danger ms-2" onclick="clearCompletedTrades()" title="Limpiar operaciones finalizadas y m√©tricas">
                            <i class="fas fa-trash-alt"></i> Limpiar
                        </button>
                    </h3>
                    <div class="orders-container" id="closedOrdersContainer" style="max-height: 450px; overflow-y: auto;">
                        <p class="text-center text-muted">Sin operaciones cerradas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let ws = null;
    let reconnectAttempts = 0;
    
    console.log('‚úÖ Dashboard Script cargado - Versi√≥n Moderna');
    
    // Conectar WebSocket
    function connect() {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/trading/`;
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('‚úÖ WebSocket conectado');
            document.getElementById('connectionStatus').className = 'connected';
            document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-circle"></i> Conectado';
            reconnectAttempts = 0;
            ws.send(JSON.stringify({type: 'request_update'}));
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'trading_update') {
                updateDashboard(data.data);
                updatePrice(data.data);
            }
        };
        
        ws.onerror = function(error) {
            console.error('‚ùå WebSocket error:', error);
        };
        
        ws.onclose = function() {
            console.log('‚ö†Ô∏è WebSocket desconectado');
            const connectionStatusNav = document.getElementById('connectionStatusNav');
            if (connectionStatusNav) {
                connectionStatusNav.className = 'nav-link disconnected';
                connectionStatusNav.innerHTML = '<i class="fas fa-circle"></i> Desconectado';
            }
            
            // Reconectar despu√©s de un delay
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
            setTimeout(connect, delay);
        };
    }
    
    // Seleccionar s√≠mbolo
    function selectSymbol(symbol) {
        selectedSymbol = symbol;
        document.querySelectorAll('.symbol-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        fetchLatestPrice(symbol);
        loadTicksHistory(symbol, 50);
    }
    
    // Obtener √∫ltimo precio
    async function fetchLatestPrice(symbol) {
        try {
            const response = await fetch(`/engine/ticks/realtime/?symbol=${symbol}&limit=1`);
            const data = await response.json();
            
            if (data.ticks && data.ticks.length > 0) {
                const tick = data.ticks[0];
                const price = parseFloat(tick.price);
                
                updatePriceDisplay(price);
                
                if (lastPrice !== null) {
                    const change = price - lastPrice;
                    const changePct = (change / lastPrice) * 100;
                    updatePriceChange(change, changePct);
                }
                
                lastPrice = price;
                document.getElementById('lastUpdate').innerHTML = 
                    `<small><i class="fas fa-clock"></i> √öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}</small>`;
            }
        } catch (error) {
            console.error('Error fetching price:', error);
        }
    }
    
    // Actualizar display de precio
    function updatePriceDisplay(price) {
        const priceElement = document.getElementById('currentPrice');
        if (priceElement) {
            priceElement.textContent = '$' + price.toFixed(4);
            priceElement.style.animation = 'none';
            setTimeout(() => {
                priceElement.style.animation = 'pulse-glow 2s infinite';
            }, 10);
        }
    }
    
    // Actualizar cambio de precio
    function updatePriceChange(change, changePct) {
        const changeElement = document.getElementById('priceChange');
        const valueElement = document.getElementById('priceChangeValue');
        const pctElement = document.getElementById('priceChangePct');
        
        if (changeElement && valueElement && pctElement) {
            const sign = change >= 0 ? '+' : '';
            valueElement.textContent = `${sign}$${change.toFixed(4)}`;
            pctElement.textContent = `(${sign}${changePct.toFixed(2)}%)`;
            
            changeElement.className = change >= 0 ? 'price-change positive' : 'price-change negative';
        }
    }
    
    // Actualizar dashboard completo
    function updateDashboard(data) {
        if (data && data.latest_tick) {
            updatePriceDisplay(parseFloat(data.latest_tick.price));
        }
    }
    
    // Actualizar precio desde data
    function updatePrice(data) {
        if (data && data.latest_tick) {
            const price = parseFloat(data.latest_tick.price);
            if (lastPrice !== null && price !== lastPrice) {
                const change = price - lastPrice;
                const changePct = (change / lastPrice) * 100;
                updatePriceChange(change, changePct);
            }
            lastPrice = price;
        }
    }
    
    // Actualizar m√©tricas
    function updateMetrics(metrics) {
        if (!metrics) return;
        
        const totalPnlEl = document.getElementById('totalPnl');
        const winRateEl = document.getElementById('winRate');
        const totalTradesEl = document.getElementById('totalTrades');
        const activeTradesEl = document.getElementById('activeTrades');
        
        if (totalPnlEl) totalPnlEl.textContent = '$' + (metrics.total_pnl || 0).toFixed(2);
        if (winRateEl) winRateEl.textContent = (metrics.win_rate || 0).toFixed(2) + '%';
        if (totalTradesEl) totalTradesEl.textContent = metrics.total_trades || 0;
        if (activeTradesEl) activeTradesEl.textContent = metrics.active_trades || 0;
    }
    
    // Actualizar estado del trading
    function updateTradingState(metrics) {
        if (!metrics) return;
        
        const stateEl = document.getElementById('tradingState');
        const detailsEl = document.getElementById('tradingStateDetails');
        const cardEl = document.getElementById('tradingStateCard');
        
        if (!stateEl || !detailsEl || !cardEl) return;
        
        const winrate = (metrics.win_rate || 0);  // Ya viene como decimal (0-1)
        const drawdown = metrics.drawdown_pct || 0;
        
        let state = 'normal';
        let stateText = 'Normal';
        let stateClass = 'bg-info';
        let stateIcon = 'fa-chart-line';
        let details = '';
        
        // Determinar estado
        if (winrate >= 0.60 && drawdown < 0.02) {
            state = 'muy_activo';
            stateText = 'Muy Activo';
            stateClass = 'bg-success';
            stateIcon = 'fa-rocket';
            details = `Winrate: ${(winrate * 100).toFixed(1)}% | Drawdown: ${(drawdown * 100).toFixed(1)}%`;
        } else if (winrate >= 0.52 && drawdown < 0.05) {
            state = 'normal';
            stateText = 'Normal';
            stateClass = 'bg-info';
            stateIcon = 'fa-chart-line';
            details = `Winrate: ${(winrate * 100).toFixed(1)}% | Drawdown: ${(drawdown * 100).toFixed(1)}%`;
        } else if (winrate >= 0.45 || drawdown < 0.10) {
            state = 'conservador';
            stateText = 'Conservador';
            stateClass = 'bg-warning';
            stateIcon = 'fa-shield-alt';
            details = `Winrate: ${(winrate * 100).toFixed(1)}% | Drawdown: ${(drawdown * 100).toFixed(1)}%`;
        } else {
            state = 'sospechoso';
            stateText = 'Sospechoso';
            stateClass = 'bg-danger';
            stateIcon = 'fa-exclamation-triangle';
            details = `Winrate: ${(winrate * 100).toFixed(1)}% | Drawdown: ${(drawdown * 100).toFixed(1)}%`;
        }
        
        stateEl.innerHTML = `<span class="badge ${stateClass}" style="font-size: 1.2rem; padding: 0.5rem 1rem;"><i class="fas ${stateIcon}"></i> ${stateText}</span>`;
        detailsEl.innerHTML = `<small>${details}</small>`;
        
        // Cambiar color del borde de la tarjeta seg√∫n estado
        if (state === 'muy_activo') {
            cardEl.style.border = '2px solid var(--success-color)';
        } else if (state === 'normal') {
            cardEl.style.border = '1px solid var(--dark-border)';
        } else if (state === 'conservador') {
            cardEl.style.border = '2px solid var(--warning-color)';
        } else {
            cardEl.style.border = '2px solid var(--danger-color)';
        }
    }
    
    // Actualizar trades activos
    function updateActiveTrades(trades) {
        const container = document.getElementById('activeOrdersContainer');
        
        if (!trades || trades.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">Sin operaciones activas</p>';
            return;
        }
        
        container.innerHTML = '<table class="table table-sm table-dark"><thead><tr><th>S√≠mbolo</th><th>Tipo</th><th>Precio</th><th>Monto</th><th>Confianza</th><th>Estrategia</th><th>Contract ID</th><th>Hora</th></tr></thead><tbody>' +
            trades.map(trade => `
                <tr>
                    <td><strong>${trade.symbol}</strong></td>
                    <td><span class="badge ${trade.direction === 'CALL' ? 'bg-success' : 'bg-danger'}">${trade.direction}</span></td>
                    <td>$${parseFloat(trade.price || 0).toFixed(4)}</td>
                    <td><strong>$${parseFloat(trade.amount || 0).toFixed(2)}</strong></td>
                    <td>${trade.confidence_pct != null ? (parseFloat(trade.confidence_pct).toFixed(1) + '%') : '-'}</td>
                    <td><span class="badge bg-info">${trade.strategy || 'Desconocida'}</span></td>
                    <td><code>${trade.contract_id || '-'}</code></td>
                    <td>${new Date(trade.timestamp).toLocaleTimeString()}</td>
                </tr>
            `).join('') +
            '</tbody></table>';
    }
    
    // Actualizar trades completados
    function updateCompletedTrades(trades) {
        const container = document.getElementById('closedOrdersContainer');
        
        if (!trades || trades.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">Sin operaciones cerradas</p>';
            return;
        }
        
        container.innerHTML = '<table class="table table-sm table-dark"><thead><tr><th>S√≠mbolo</th><th>Tipo</th><th>Precio</th><th>Monto</th><th>Confianza</th><th>Estrategia</th><th>Estado</th><th>Contract ID</th><th>Hora</th></tr></thead><tbody>' +
            trades.map(trade => {
                // Para operaciones finalizadas: si fue p√©rdida, mostrar monto en positivo
                let displayAmount = parseFloat(trade.amount || 0);
                let amountClass = '';
                
                if (trade.status === 'lost' && displayAmount > 0) {
                    // Si fue p√©rdida, mostrar el monto en positivo
                    displayAmount = Math.abs(displayAmount);
                    amountClass = 'text-danger';
                } else if (trade.status === 'won') {
                    amountClass = 'text-success';
                }
                
                return `
                <tr>
                    <td><strong>${trade.symbol}</strong></td>
                    <td><span class="badge ${trade.direction === 'CALL' ? 'bg-success' : 'bg-danger'}">${trade.direction}</span></td>
                    <td>$${parseFloat(trade.price || 0).toFixed(4)}</td>
                    <td class="${amountClass}"><strong>$${displayAmount.toFixed(2)}</strong></td>
                    <td>${trade.confidence_pct != null ? (parseFloat(trade.confidence_pct).toFixed(1) + '%') : '-'}</td>
                    <td><span class="badge bg-info">${trade.strategy || 'Desconocida'}</span></td>
                    <td><span class="badge ${trade.status === 'won' ? 'bg-success' : trade.status === 'lost' ? 'bg-danger' : 'bg-warning'}">${trade.status}</span></td>
                    <td><code>${trade.contract_id || '-'}</code></td>
                    <td>${new Date(trade.timestamp).toLocaleTimeString()}</td>
                </tr>
            `;
            }).join('') +
            '</tbody></table>';
    }
    
    // Cargar hist√≥rico de ticks
    async function loadTicksHistory(symbol, limit = 50) {
        try {
            const response = await fetch(`/engine/ticks/realtime/?symbol=${symbol}&limit=${limit}`);
            const data = await response.json();
            
            const tbody = document.getElementById('ticksHistoryTable');
            if (data.ticks && data.ticks.length > 0) {
                tbody.innerHTML = data.ticks.map(tick => `
                    <tr>
                        <td><strong>${tick.symbol || symbol}</strong></td>
                        <td>$${parseFloat(tick.price).toFixed(4)}</td>
                        <td>${parseFloat(tick.volume || 0).toFixed(2)}</td>
                        <td>${new Date(tick.timestamp).toLocaleString()}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay datos disponibles</td></tr>';
            }
        } catch (error) {
            console.error('Error loading ticks history:', error);
        }
    }
    
    // Actualizar balance
    async function updateBalance() {
        try {
            const response = await fetch('/engine/balance/');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Actualizar estado de conexi√≥n basado en la respuesta
            const connectionStatusNav = document.getElementById('connectionStatusNav');
            if (connectionStatusNav) {
                if (data.success && data.connected !== false) {
                    connectionStatusNav.className = 'nav-link connected';
                    connectionStatusNav.innerHTML = '<i class="fas fa-circle"></i> Conectado';
                } else {
                    connectionStatusNav.className = 'nav-link disconnected';
                    connectionStatusNav.innerHTML = '<i class="fas fa-circle"></i> Desconectado';
                }
            }
            
            if (data.success && data.balance !== undefined) {
                const balance = parseFloat(data.balance);
                const formattedBalance = '$' + balance.toFixed(2);
                
                // Actualizar tarjeta principal de balance (la grande)
                const mainBalanceElement = document.getElementById('mainBalanceAmount');
                if (mainBalanceElement) {
                    mainBalanceElement.textContent = formattedBalance;
                    
                    // Efecto visual de actualizaci√≥n en tiempo real
                    mainBalanceElement.style.transition = 'all 0.3s ease';
                    mainBalanceElement.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        mainBalanceElement.style.transform = 'scale(1)';
                    }, 300);
                }
                
                // Tambi√©n actualizar el balance en el header (si existe)
                const headerBalanceElement = document.getElementById('balanceAmount');
                if (headerBalanceElement) {
                    headerBalanceElement.textContent = formattedBalance;
                }
                
                // Si hay warning (rate limit), mostrarlo en consola
                if (data.warning) {
                    console.warn('‚ö†Ô∏è Balance:', data.warning);
                }
            } else {
                // Si hay error, mostrar en consola y actualizar UI
                const errorMsg = data.error || 'Error desconocido al obtener balance';
                console.error('‚ùå Error obteniendo balance:', errorMsg);
                
                // Mostrar error en la tarjeta de balance
                const mainBalanceElement = document.getElementById('mainBalanceAmount');
                if (mainBalanceElement) {
                    mainBalanceElement.textContent = '$0.00';
                    mainBalanceElement.title = errorMsg;
                }
            }
        } catch (error) {
            console.error('‚ùå Error fetching balance:', error);
            
            // Actualizar estado a desconectado
            const connectionStatusNav = document.getElementById('connectionStatusNav');
            if (connectionStatusNav) {
                connectionStatusNav.className = 'nav-link disconnected';
                connectionStatusNav.innerHTML = '<i class="fas fa-circle"></i> Desconectado';
            }
            
            // Mostrar 0.00 si hay error
            const mainBalanceElement = document.getElementById('mainBalanceAmount');
            if (mainBalanceElement) {
                mainBalanceElement.textContent = '$0.00';
                mainBalanceElement.title = `Error: ${error.message}`;
            }
        }
    }
    
    // Actualizar trades
    async function updateTrades() {
        try {
            const response = await fetch('/engine/trades/');
            const data = await response.json();
            
            if (data.success) {
                updateActiveTrades(data.active || []);
                updateCompletedTrades(data.completed || []);
                if (data.metrics) {
                    updateMetrics(data.metrics);
                    updateTradingState(data.metrics);
                }
            }
        } catch (error) {
            console.error('Error fetching trades:', error);
        }
    }
    
    // Limpiar operaciones finalizadas
    async function clearCompletedTrades() {
        if (!confirm('¬øEst√° seguro de que desea limpiar TODAS las operaciones finalizadas y resetear las m√©tricas?\n\nEsta acci√≥n NO se puede deshacer.')) {
            return;
        }
        
        try {
            const response = await fetch('/engine/api/clear-completed-trades/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`‚úÖ ${data.message}\n\nOperaciones eliminadas: ${data.deleted_count}`);
                // Recargar trades
                updateTrades();
                // Recargar balance
                updateBalance();
            } else {
                alert(`‚ùå Error: ${data.error || 'Error desconocido'}`);
            }
        } catch (error) {
            console.error('Error clearing trades:', error);
            alert(`‚ùå Error de conexi√≥n: ${error.message}`);
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Inicializando dashboard...');
        
        // Conectar WebSocket
        connect();
        
        // Cargar datos iniciales
        // Actualizar balance inmediatamente y luego cada 2 segundos para tiempo real
        updateBalance();
        setInterval(updateBalance, 2000);
        
        // Actualizar trades inmediatamente y luego cada 2 segundos
        updateTrades();
        setInterval(updateTrades, 2000);
    });
</script>
{% endblock %}
